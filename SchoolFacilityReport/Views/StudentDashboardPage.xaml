<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SchoolFacilityReport.ViewModels"
             x:Class="SchoolFacilityReport.Views.StudentDashboardPage"
             Title="New Report"
             BackgroundColor="{StaticResource PageBackground}"
             Shell.NavBarIsVisible="False">

    <!-- BindingContext is set in CodeBehind via Dependency Injection -->

    <Grid RowDefinitions="Auto, *">
        <!-- Modern Header -->
        <Border Grid.Row="0" 
                BackgroundColor="White" 
                StrokeThickness="0" 
                Padding="20,50,20,20"
                Shadow="{StaticResource Shadow}">
            <Grid ColumnDefinitions="Auto, *, Auto">
                <ImageButton Grid.Column="0" 
                             Source="{FontImage Glyph='â®', Color={StaticResource TextPrimary}, Size=20}"
                             Command="{Binding LogoutCommand}"
                             HorizontalOptions="Start"/>
                
                <Label Grid.Column="1" 
                       Text="New Report" 
                       FontSize="20" 
                       FontAttributes="Bold" 
                       HorizontalOptions="Center" 
                       VerticalOptions="Center"
                       TextColor="{StaticResource TextPrimary}"/>
            </Grid>
        </Border>

        <ScrollView Grid.Row="1" Padding="20">
            <VerticalStackLayout Spacing="25">

                <!-- Welcome Message -->
                <Label Text="What would you like to report?" 
                       FontSize="24" 
                       FontAttributes="Bold" 
                       TextColor="{StaticResource TextPrimary}"
                       Margin="0,10,0,0"/>

                <!-- Category Picker -->
                <VerticalStackLayout Spacing="8">
                    <Label Text="Category" TextColor="{StaticResource TextSecondary}" FontSize="14" FontAttributes="Bold"/>
                    <Border StrokeShape="RoundRectangle 12" StrokeThickness="0" BackgroundColor="{StaticResource SurfaceAlt}" Padding="0">
                        <Picker Title="Select Category" 
                                ItemsSource="{Binding Categories}"
                                SelectedItem="{Binding SelectedCategory}"
                                TextColor="{StaticResource TextPrimary}"
                                TitleColor="{StaticResource TextSecondary}"
                                BackgroundColor="Transparent"
                                Margin="15,0"/>
                    </Border>
                </VerticalStackLayout>

                <!-- Urgency Segmented Control (Custom) -->
                <VerticalStackLayout Spacing="8">
                    <Label Text="Urgency" TextColor="{StaticResource TextSecondary}" FontSize="14" FontAttributes="Bold"/>
                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10">
                        <Button Grid.Column="0" Text="Low" 
                                BackgroundColor="{StaticResource Success}" 
                                TextColor="White" 
                                CornerRadius="12" 
                                Command="{Binding SetUrgencyCommand}" 
                                CommandParameter="1"
                                Opacity="{Binding UrgencyOpacity1}"/>
                        <Button Grid.Column="1" Text="Medium" 
                                BackgroundColor="{StaticResource Warning}" 
                                TextColor="White" 
                                CornerRadius="12" 
                                Command="{Binding SetUrgencyCommand}" 
                                CommandParameter="2"
                                Opacity="{Binding UrgencyOpacity2}"/>
                        <Button Grid.Column="2" Text="High" 
                                BackgroundColor="{StaticResource Error}" 
                                TextColor="White" 
                                CornerRadius="12" 
                                Command="{Binding SetUrgencyCommand}" 
                                CommandParameter="3"
                                Opacity="{Binding UrgencyOpacity3}"/>
                    </Grid>
                </VerticalStackLayout>

                <!-- Description Editor -->
                <VerticalStackLayout Spacing="8">
                    <Label Text="Description" TextColor="{StaticResource TextSecondary}" FontSize="14" FontAttributes="Bold"/>
                    <Border StrokeShape="RoundRectangle 12" StrokeThickness="0" BackgroundColor="{StaticResource SurfaceAlt}" Padding="0">
                        <Editor Placeholder="Describe the issue in detail..." 
                                Text="{Binding Description}"
                                AutoSize="TextChanges"
                                HeightRequest="120"
                                BackgroundColor="Transparent"
                                Margin="15,10"/>
                    </Border>
                </VerticalStackLayout>

                <!-- Action Buttons -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                    <Button Grid.Column="0" 
                            Text="Photo" 
                            ImageSource="{FontImage Glyph='ðŸ“·', Color={StaticResource Primary}, Size=18}"
                            Command="{Binding TakePhotoCommand}"
                            BackgroundColor="{StaticResource Surface}"
                            TextColor="{StaticResource Primary}"
                            BorderColor="{StaticResource PrimarySoft}"
                            BorderWidth="1"/>
                            
                    <Button Grid.Column="1" 
                            Text="Location" 
                            ImageSource="{FontImage Glyph='ðŸ“', Color={StaticResource Primary}, Size=18}"
                            Command="{Binding GetLocationCommand}"
                            BackgroundColor="{StaticResource Surface}"
                            TextColor="{StaticResource Primary}"
                            BorderColor="{StaticResource PrimarySoft}"
                            BorderWidth="1"/>
                </Grid>

                <!-- Photo Preview -->
                <Image Source="{Binding PhotoData}" 
                       HeightRequest="200" 
                       Aspect="AspectFill"
                       IsVisible="{Binding PhotoData, Converter={x:StaticResource IsNotNullConverter}}">
                    <Image.Clip>
                        <RoundRectangleGeometry CornerRadius="12"/>
                    </Image.Clip>
                </Image>

                <!-- Location Label -->
                <Label Text="{Binding LocationDisplay}" 
                       TextColor="{StaticResource TextSecondary}" 
                       FontSize="13"
                       IsVisible="{Binding LocationDisplay, Converter={x:StaticResource IsNotNullConverter}}"/>

                <!-- Submit Button -->
                <Button Text="Submit Report" 
                        Command="{Binding SubmitReportCommand}"
                        IsEnabled="{Binding IsNotBusy}"
                        Margin="0,20,0,40"
                        Style="{StaticResource Button}"/>
            </VerticalStackLayout>
        </ScrollView>
        
        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="2" BackgroundColor="#80FFFFFF" IsVisible="{Binding IsBusy}">
            <ActivityIndicator IsRunning="True" HorizontalOptions="Center" VerticalOptions="Center"/>
        </Grid>
    </Grid>
</ContentPage>