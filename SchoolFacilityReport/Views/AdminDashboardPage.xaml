<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SchoolFacilityReport.ViewModels"
             x:Class="SchoolFacilityReport.Views.AdminDashboardPage"
             Title="Admin Dashboard"
             BackgroundColor="{StaticResource PageBackground}"
             Shell.NavBarIsVisible="False">

    <!-- BindingContext is set in CodeBehind via Dependency Injection -->

    <Grid RowDefinitions="Auto, *">
        <!-- Top Navigation Bar -->
        <Border Grid.Row="0" 
                BackgroundColor="White" 
                StrokeThickness="0" 
                Padding="20,15,20,15"
                Shadow="{StaticResource Shadow}">
            <Grid ColumnDefinitions="Auto, *, Auto">
                <ImageButton Grid.Column="0" 
                             Source="{FontImage Glyph='⚙', Color={StaticResource TextPrimary}, Size=24}"
                             Command="{Binding GoToSettingsCommand}"
                             HorizontalOptions="Start"/>

                <Label Grid.Column="1" 
                       Text="Admin Panel" 
                       FontSize="18" 
                       FontAttributes="Bold" 
                       HorizontalOptions="Center" 
                       VerticalOptions="Center"
                       TextColor="{StaticResource TextPrimary}"/>
                
                <ImageButton Grid.Column="2" 
                             Source="{FontImage Glyph='🔄', Color={StaticResource Primary}, Size=24}"
                             Command="{Binding LoadAllReportsCommand}"
                             HorizontalOptions="End"/>
            </Grid>
        </Border>

        <!-- Main Content Area -->
        <RefreshView Grid.Row="1" 
                     Command="{Binding LoadAllReportsCommand}" 
                     IsRefreshing="{Binding IsRefreshing}"
                     Padding="20">
            <CollectionView ItemsSource="{Binding AllReports}" 
                            SelectionMode="Single"
                            SelectionChangedCommand="{Binding GoToDetailsCommand}"
                            SelectionChangedCommandParameter="{Binding Path=SelectedItem, Source={RelativeSource Self}}">
                
                <CollectionView.Header>
                    <VerticalStackLayout Spacing="20" Margin="0,10,0,20">
                        <!-- Stats Overview Header -->
                        <Label Text="Overview" 
                               FontSize="22" 
                               FontAttributes="Bold" 
                               TextColor="{StaticResource TextPrimary}"/>

                        <!-- Dashboard Stats Grid -->
                        <Grid ColumnDefinitions="*, *" RowDefinitions="Auto, Auto" ColumnSpacing="15" RowSpacing="15">
                            
                            <!-- Total Reports -->
                            <Border Grid.Row="0" Grid.Column="0"
                                    StrokeShape="RoundRectangle 16"
                                    StrokeThickness="0"
                                    BackgroundColor="#E3F2FD"
                                    Padding="15"
                                    HeightRequest="100">
                                <VerticalStackLayout VerticalOptions="Center" Spacing="5">
                                    <Label Text="{Binding TotalReportsCount}" 
                                           FontSize="28" 
                                           FontAttributes="Bold" 
                                           TextColor="#1565C0"
                                           HorizontalOptions="Center"/>
                                    <Label Text="Total Reports" 
                                           FontSize="13" 
                                           TextColor="#1976D2"
                                           HorizontalOptions="Center"/>
                                </VerticalStackLayout>
                            </Border>

                            <!-- High Urgency -->
                            <Border Grid.Row="0" Grid.Column="1"
                                    StrokeShape="RoundRectangle 16"
                                    StrokeThickness="0"
                                    BackgroundColor="#FFEBEE"
                                    Padding="15"
                                    HeightRequest="100">
                                <VerticalStackLayout VerticalOptions="Center" Spacing="5">
                                    <Label Text="{Binding HighUrgencyCount}" 
                                           FontSize="28" 
                                           FontAttributes="Bold" 
                                           TextColor="#C62828"
                                           HorizontalOptions="Center"/>
                                    <Label Text="Urgent Action" 
                                           FontSize="13" 
                                           TextColor="#D32F2F"
                                           HorizontalOptions="Center"/>
                                </VerticalStackLayout>
                            </Border>

                            <!-- Pending -->
                            <Border Grid.Row="1" Grid.Column="0"
                                    StrokeShape="RoundRectangle 16"
                                    StrokeThickness="0"
                                    BackgroundColor="#FFF3E0"
                                    Padding="15"
                                    HeightRequest="100">
                                <VerticalStackLayout VerticalOptions="Center" Spacing="5">
                                    <Label Text="{Binding PendingReportsCount}" 
                                           FontSize="28" 
                                           FontAttributes="Bold" 
                                           TextColor="#EF6C00"
                                           HorizontalOptions="Center"/>
                                    <Label Text="Pending" 
                                           FontSize="13" 
                                           TextColor="#F57C00"
                                           HorizontalOptions="Center"/>
                                </VerticalStackLayout>
                            </Border>

                            <!-- Completed -->
                            <Border Grid.Row="1" Grid.Column="1"
                                    StrokeShape="RoundRectangle 16"
                                    StrokeThickness="0"
                                    BackgroundColor="#E8F5E9"
                                    Padding="15"
                                    HeightRequest="100">
                                <VerticalStackLayout VerticalOptions="Center" Spacing="5">
                                    <Label Text="{Binding CompletedReportsCount}" 
                                           FontSize="28" 
                                           FontAttributes="Bold" 
                                           TextColor="#2E7D32"
                                           HorizontalOptions="Center"/>
                                    <Label Text="Completed" 
                                           FontSize="13" 
                                           TextColor="#388E3C"
                                           HorizontalOptions="Center"/>
                                </VerticalStackLayout>
                            </Border>
                        </Grid>

                        <Label Text="Recent Reports" 
                               FontSize="20" 
                               FontAttributes="Bold" 
                               Margin="0,10,0,0"
                               TextColor="{StaticResource TextPrimary}"/>
                    </VerticalStackLayout>
                </CollectionView.Header>

                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="15"/>
                </CollectionView.ItemsLayout>
                
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border StrokeThickness="0" 
                                StrokeShape="RoundRectangle 16"
                                BackgroundColor="White"
                                Padding="15">
                            <Border.Shadow>
                                <Shadow Brush="Black" Offset="0,2" Radius="5" Opacity="0.1"/>
                            </Border.Shadow>
                            
                            <Grid ColumnDefinitions="80, *" ColumnSpacing="15">
                                <!-- Image Thumbnail -->
                                <Border Grid.Column="0" 
                                        HeightRequest="80" 
                                        WidthRequest="80" 
                                        StrokeShape="RoundRectangle 12" 
                                        StrokeThickness="0"
                                        BackgroundColor="{StaticResource SurfaceAlt}">
                                    <Image Source="{Binding ImagePath}" Aspect="AspectFill"/>
                                </Border>
                                
                                <!-- Info -->
                                <VerticalStackLayout Grid.Column="1" Spacing="6" VerticalOptions="Center">
                                    <Grid ColumnDefinitions="*, Auto">
                                        <Label Grid.Column="0" 
                                               Text="{Binding Category}" 
                                               FontSize="16" 
                                               FontAttributes="Bold" 
                                               TextColor="{StaticResource TextPrimary}"/>
                                        
                                        <!-- Urgency Dot -->
                                        <BoxView Grid.Column="1" 
                                                 Color="{Binding UrgencyColor}" 
                                                 HeightRequest="10" 
                                                 WidthRequest="10" 
                                                 CornerRadius="5"
                                                 VerticalOptions="Center"/>
                                    </Grid>
                                    
                                    <Label Text="{Binding Description}" 
                                           MaxLines="2" 
                                           LineBreakMode="TailTruncation" 
                                           TextColor="{StaticResource TextSecondary}" 
                                           FontSize="13"/>
                                           
                                    <Grid ColumnDefinitions="*, Auto" Margin="0,5,0,0">
                                        <Label Grid.Column="0" 
                                               Text="{Binding CreatedAt, StringFormat='{0:MMM dd}'}" 
                                               TextColor="{StaticResource Gray400}" 
                                               FontSize="12"/>
                                        
                                        <!-- Status Pill -->
                                        <Border Grid.Column="1" 
                                                StrokeThickness="0" 
                                                BackgroundColor="{Binding StatusColor}"
                                                StrokeShape="RoundRectangle 8"
                                                Padding="10,4">
                                            <Label Text="{Binding Status}" 
                                                   TextColor="White" 
                                                   FontSize="11" 
                                                   FontAttributes="Bold"/>
                                        </Border>
                                    </Grid>
                                </VerticalStackLayout>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                
                <CollectionView.EmptyView>
                    <VerticalStackLayout Spacing="10" VerticalOptions="Center" HorizontalOptions="Center" Margin="0,50,0,0">
                        <Label Text="📝" FontSize="48" HorizontalOptions="Center"/>
                        <Label Text="No reports found" 
                               TextColor="{StaticResource TextSecondary}" 
                               HorizontalOptions="Center"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </RefreshView>
    </Grid>
</ContentPage>